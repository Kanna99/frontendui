// Create a Redux store holding the state of your app.
// Its API is { subscribe, dispatch, getState }.
const store = Redux.createStore(app);

function app(state, action) {

  var initialState = {
    'player': 'X',
    'ai': 'O',
    'turn': false,
    'boxes': [],
    'winner': false, // 'X', 'O', 'draw'
  }

  for (var i = 0; i < 9; i++) {
    initialState.boxes.push({
      id: i,
      player: ''
    });
  }

  if (typeof state === 'undefined') {
    return initialState;
  }

  switch (action.type) {
    case 'BOX_CLICK':

      var boxes = state.boxes.slice(),
        currentPlayer = state.turn,
        nextPlayer = getOppositePlayer(currentPlayer);

      var boxFilled = boxes[action.id].player.length;
      if (boxFilled || state.winner) {
        return state; //do nothing
      }

      boxes[action.id].player = currentPlayer;
      var newState = {...state,
          'boxes': boxes};

      if (hasWon(boxes, currentPlayer)) {
        return {...newState,
          'winner': currentPlayer
        };
      } else if (isDraw(boxes)) {
        return {...newState,
          'winner': 'draw'
        };
      }

      return {...newState,
        'turn': nextPlayer
      };

    case 'AI_TURN':
      if (state.winner || state.turn != state.ai) {
        return state; //do nothing
      }
      var boxes = state.boxes.slice(),
        currentPlayer = state.turn,
        nextPlayer = getOppositePlayer(currentPlayer);

      var minmax = minimax(boxes, currentPlayer);
      boxes[minmax].player = state.ai;
      
      var newState = {...state,
          'boxes': boxes, 'timeout': false};

      if (hasWon(boxes, currentPlayer)) {
        return {...newState,
          'winner': currentPlayer
        };
      } else if (isDraw(boxes)) {
        return {...newState,
          'winner': 'draw'
        };
      }
      return {...newState,
        'turn': nextPlayer
      };
      
    case 'SET_TIMEOUT_AI':
      return {...state, 'timeout': true}
      
    case 'CHOOSE_XO':
      
      return {...state, 'player': action.id, 'ai': getOppositePlayer(action.id), 'turn': Math.random() >= 0.5 ? 'X' : 'O'}

    case 'RESET':
      return initialState
    default:
      return state
  }
}

var hasWon = function(boxes, player) {
  if (boxes[0]) {
    // horizontal
    if (boxes[0].player == player && boxes[1].player == player && boxes[2].player == player) return true;
    if (boxes[3].player == player && boxes[4].player == player && boxes[5].player == player) return true;
    if (boxes[6].player == player && boxes[7].player == player && boxes[8].player == player) return true;
    // vertical
    if (boxes[0].player == player && boxes[3].player == player && boxes[6].player == player) return true;
    if (boxes[1].player == player && boxes[4].player == player && boxes[7].player == player) return true;
    if (boxes[2].player == player && boxes[5].player == player && boxes[8].player == player) return true;
    // diagonal
    if (boxes[0].player == player && boxes[4].player == player && boxes[8].player == player) return true;
    if (boxes[6].player == player && boxes[4].player == player && boxes[2].player == player) return true;
  }
  return false;
};

var isDraw = function(boxes) {
  return boxes.every(function(box) {
    return Boolean(box.player.length);
  });
}

var getOppositePlayer = function(player) {
  return player == 'X' ? 'O' : 'X';
}

var minimax = function(board, player) {

  var availableMoves = board.filter(function(box) {
      return !box.player.length;
    }),
    nextPlayer = getOppositePlayer(player);

  if (!availableMoves.length) {
    return false;
  } else if (availableMoves.length == 1) {
    return availableMoves[0].id;
  }

  var bestValue = availableMoves.map(function(move, i, arr) {

    var nextMove = board.slice(0),
      score = -10;
    nextMove[move.id] = {
      id: move.id,
      player: player
    };

    if (hasWon(nextMove, player)) {
      score = 10;
    } else {
      nextMove[move.id] = {
        id: move.id,
        player: nextPlayer
      };
      if (hasWon(nextMove, nextPlayer)) {
        score = 0;
      }
    }
    return {
      'score': score,
      'id': move.id
    }
  });

  var items = bestValue.reduce(function(acc, val) {
    if (!acc.length || val.score > acc[0].score) return [val];
    if (val.score == acc[0].score) return acc.concat(val);
    return acc;
  }, []);

  return items[Math.floor(Math.random() * items.length)].id;
}

class Box extends React.Component {
  constructor(props) {
    super(props);
  }
  
  render() {
    if(this.props.disabled) return (
      <div className="box disabled">
        {this.props.player}
      </div> 
    );
    return (
      <div className="box" onClick={this.props.onClick}>
        {this.props.player}
      </div> );
  }
}

const Status = ({
  winner,
  turn,
  ai
}) => {
  var hasWon = winner == 'X' || winner == 'O';
  if (hasWon) {
    return ( <h1>The winner is... <b>{winner == ai ? ai : 'you!'}</b></h1> );
  } else if (winner) {
    return ( <h1>It's a <b>draw</b></h1> );
  }
  return (
    <h1>It's <b>{turn == ai ? ai + '\'s' : 'your'}</b> turn</h1>
  )
};

/* 
Container components 
*/
class App extends React.Component {
  constructor(props) {
    super(props);
  }

  render() {
    var data = this.props.data,
      onBoxClick = this.props.onBoxClick,
        aiTurn = data.ai == data.turn;

    if (aiTurn) {
        window.setTimeout(this.props.onAi, 1000);
    }
    
    if(data.turn == false) {
      return (
        <div className="center">
          <h1>Do you want to play as <b>X</b> or <b>O</b>?</h1>
          <button className="xo-button x" onClick={() => this.props.onChooseXorO('X')}>X</button>
          <button className="xo-button o" onClick={() => this.props.onChooseXorO('O')}>O</button>
        </div>
      )
    }

    return (
      <div>
        <Status winner={data.winner} turn={data.turn} ai={data.ai} />
        <div className="gameboard">
          {data.boxes.map(box =>
            <Box
              disabled={aiTurn}
              id={box.id}
              {...box}
              onClick={() => onBoxClick(box.id)}
            />
          )}
        </div>
        <div className="center">
          <button className="button-anchor" onClick={this.props.onReset}>{data.winner ? 'Play again' : 'Reset game'}</button>
        </div>
        
      </div>
    )
  }
}

function render() {
  ReactDOM.render( <
    App data = {
      store.getState()
    }
    onBoxClick = {
      (id) =>
      store.dispatch({
        type: 'BOX_CLICK',
        id: id
      })
    }                 
    onAi = {
      () =>
      store.dispatch({
        type: 'AI_TURN'
      })
    }
    onChooseXorO = {
      (id) =>
      store.dispatch({
        type: 'CHOOSE_XO',
        id: id
      })
    }
    onReset = {
      () =>
      store.dispatch({
        type: 'RESET'
      })
    }
    />,
    document.getElementById('root')
  )
}

render()
store.subscribe(render)
